#!/bin/bash
# coder-mem - AI coding agent launcher
# Usage: coder-mem [directory]
#
# This script launches the coding agent from any directory.
# The working directory will be set to the current directory or specified directory.

# Get the directory where this script is located (resolve symlinks)
if [ -L "${BASH_SOURCE[0]}" ]; then
    # Script is a symlink, resolve it
    SCRIPT_PATH="$(readlink "${BASH_SOURCE[0]}")"
    SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
else
    # Script is not a symlink
    SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
fi

# Initialize variables
WORKING_DIR=""

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            echo "coder-mem - AI Coding Agent"
            echo ""
            echo "Usage:"
            echo "  coder-mem          # Run in current directory"
            echo "  coder-mem /path    # Run in specified directory"
            echo "  coder-mem --help   # Show this help"
            echo ""
            echo "Note: Use /model command inside the tool to switch LLM providers"
            echo ""
            echo "Examples:"
            echo "  coder-mem"
            echo "  coder-mem /path/to/project"
            echo ""
            echo "The tool will start with the working directory set to the specified"
            echo "directory (or current directory if none specified)."
            exit 0
            ;;
        -*)
            echo "Error: Unknown option $1"
            echo "Use --help for usage information"
            exit 1
            ;;
        *)
            if [ -z "$WORKING_DIR" ]; then
                WORKING_DIR="$1"
            else
                echo "Error: Multiple directory arguments provided"
                exit 1
            fi
            shift
            ;;
    esac
done

# Determine the working directory
if [ -n "$WORKING_DIR" ]; then
    # Directory specified as argument
    if [ ! -d "$WORKING_DIR" ]; then
        echo "Error: Directory '$WORKING_DIR' does not exist"
        exit 1
    fi
    # Convert to absolute path
    WORKING_DIR="$(cd "$WORKING_DIR" && pwd)"
else
    # Use current working directory
    WORKING_DIR="$(pwd)"
fi

echo "Starting coder-mem in: $WORKING_DIR"

# Set environment variables
export INITIAL_DIR="$WORKING_DIR"

# Run the main script with virtual environment
# Check if dependencies are installed, if not run with uv
if [ -f "$SCRIPT_DIR/.venv/bin/python" ] && "$SCRIPT_DIR/.venv/bin/python" -c "import langchain" 2>/dev/null; then
    # Venv exists and has dependencies - use it directly
    exec "$SCRIPT_DIR/.venv/bin/python" "$SCRIPT_DIR/main.py"
else
    # Use uv to ensure dependencies are installed
    cd "$SCRIPT_DIR"
    exec uv run python main.py
fi
